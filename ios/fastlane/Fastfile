# Fastfile - Deployment automation for Everyday Christian iOS app
# Documentation: https://docs.fastlane.tools

default_platform(:ios)

platform :ios do

  # ========================================
  # LANE: Beta Deployment (TestFlight)
  # ========================================
  # Usage: fastlane beta
  # Builds app, increments build number, uploads to TestFlight
  desc "Push a new beta build to TestFlight"
  lane :beta do
    # Ensure we're on a clean git state
    ensure_git_status_clean

    # Increment build number (keeps version the same)
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )

    # Build the app
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store"
      # Using automatic code signing - Xcode will manage certificates
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true, # Don't wait for Apple processing
      skip_submission: false, # Auto-submit for beta review
      distribute_external: false, # Only internal testers initially
      notify_external_testers: false
    )

    # Commit and push version bump
    commit_version_bump(
      message: "Bump build number for TestFlight beta [skip ci]",
      xcodeproj: "Runner.xcodeproj"
    )
    push_to_git_remote

    # Send success notification
    notification(
      title: "âœ… TestFlight Upload Complete",
      message: "Build uploaded successfully! Check App Store Connect for processing status."
    )
  end

  # ========================================
  # LANE: Release to App Store
  # ========================================
  # Usage: fastlane release
  # Builds app, uploads to App Store, submits for review
  desc "Deploy a new version to the App Store"
  lane :release do
    # Ensure we're on main branch
    ensure_git_branch(branch: 'main')
    ensure_git_status_clean

    # Optional: Run tests before release
    # run_tests(scheme: "Runner")

    # Increment version number (e.g., 1.0.0 -> 1.0.1)
    increment_version_number(
      bump_type: "patch", # or "minor", "major"
      xcodeproj: "Runner.xcodeproj"
    )

    # Build the app
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store"
    )

    # Upload to App Store Connect
    upload_to_app_store(
      skip_metadata: false, # Upload metadata changes
      skip_screenshots: false, # Upload screenshots if changed
      submit_for_review: true, # Auto-submit for review
      automatic_release: false, # Manual release after approval
      force: true, # Skip HTMl verification
      submission_information: {
        add_id_info_uses_idfa: false # Not using IDFA for ads
      }
    )

    # Commit version bump
    commit_version_bump(
      message: "Release version #{lane_context[SharedValues::VERSION_NUMBER]} [skip ci]",
      xcodeproj: "Runner.xcodeproj"
    )

    # Create git tag for release
    add_git_tag(
      tag: "v#{lane_context[SharedValues::VERSION_NUMBER]}"
    )

    push_to_git_remote(tags: true)

    notification(
      title: "ðŸš€ App Store Upload Complete",
      message: "Version #{lane_context[SharedValues::VERSION_NUMBER]} submitted for review!"
    )
  end

  # ========================================
  # LANE: Build Only (No Upload)
  # ========================================
  # Usage: fastlane build
  # Just builds the app without uploading
  desc "Build the iOS app without uploading"
  lane :build do
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      skip_package_ipa: false
    )

    notification(
      title: "âœ… Build Complete",
      message: "IPA file ready in build output directory"
    )
  end

  # ========================================
  # LANE: Capture Screenshots
  # ========================================
  # Usage: fastlane screenshots
  # Takes screenshots for all device sizes
  desc "Generate screenshots for App Store"
  lane :screenshots do
    capture_screenshots(
      scheme: "Runner",
      output_directory: "./fastlane/screenshots",
      clear_previous_screenshots: true,
      dark_mode: false
    )

    # Optionally upload to App Store Connect
    # upload_to_app_store(
    #   skip_binary_upload: true,
    #   skip_metadata: true
    # )
  end

  # ========================================
  # LANE: Update Metadata
  # ========================================
  # Usage: fastlane metadata
  # Updates App Store metadata without uploading a new build
  desc "Update App Store metadata only"
  lane :metadata do
    upload_to_app_store(
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true
    )

    notification(
      title: "ðŸ“ Metadata Updated",
      message: "App Store metadata updated successfully"
    )
  end

  # ========================================
  # LANE: Run Tests
  # ========================================
  # Usage: fastlane test
  # Runs all unit and UI tests
  desc "Run all tests"
  lane :test do
    run_tests(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      devices: ["iPhone 15 Pro"],
      clean: true
    )
  end

  # ========================================
  # LANE: Version Bump (Patch)
  # ========================================
  # Usage: fastlane bump
  # Increments patch version (1.0.0 -> 1.0.1)
  desc "Bump version number (patch)"
  lane :bump do
    ensure_git_status_clean

    increment_version_number(
      bump_type: "patch",
      xcodeproj: "Runner.xcodeproj"
    )

    version = get_version_number(xcodeproj: "Runner.xcodeproj")

    commit_version_bump(
      message: "Bump version to #{version} [skip ci]",
      xcodeproj: "Runner.xcodeproj"
    )

    push_to_git_remote

    UI.success("âœ… Version bumped to #{version}")
  end

  # ========================================
  # LANE: Match (Code Signing)
  # ========================================
  # Usage: fastlane sync_certificates
  # Syncs code signing certificates and profiles
  desc "Sync code signing certificates and profiles"
  lane :sync_certificates do
    match(
      type: "appstore",
      readonly: true, # Don't create new certificates
      app_identifier: "com.elev8tion.everydaychristian"
    )
  end

  # ========================================
  # ERROR HANDLING
  # ========================================
  error do |lane, exception|
    notification(
      title: "âŒ Fastlane Error",
      message: "Lane '#{lane}' failed: #{exception.message}"
    )
  end
end
# Add this lane to query App Store Connect

lane :query_status do
  api_key = app_store_connect_api_key(
    key_id: "T9L7G79827",
    issuer_id: "e5761715-cdcf-42cb-b50e-09977a5c8279",
    key_filepath: "#{Dir.home}/private_keys/AuthKey_T9L7G79827.p8",
    duration: 1200,
    in_house: false
  )
  
  UI.header "Everyday Christian - App Store Status"
  
  # Get app info
  app = Spaceship::ConnectAPI::App.find("com.elev8tion.everydaychristian")
  
  if app
    UI.success "Found app: #{app.name}"
    UI.message "Bundle ID: #{app.bundle_id}"
    
    # Get versions
    live_version = app.get_live_app_store_version
    edit_version = app.get_edit_app_store_version
    
    if live_version
      UI.success "Live Version: #{live_version.version_string} (#{live_version.app_store_state})"
    end
    
    if edit_version
      UI.important "Edit Version: #{edit_version.version_string}"
      UI.important "Status: #{edit_version.app_store_state}"
      
      if edit_version.app_store_state.include?("REJECT")
        UI.error "âš ï¸  VERSION REJECTED!"
        UI.error "Check Resolution Center for details"
      end
    end
    
    # Get builds
    UI.header "TestFlight Builds"
    builds = app.get_builds(limit: 10)
    builds.each do |build|
      UI.message "  Build #{build.version} (#{build.build_number}) - #{build.processing_state}"
    end
    
    # Get IAPs
    UI.header "In-App Purchases"
    begin
      subscription_groups = app.get_subscription_groups
      subscription_groups.each do |group|
        UI.message "Group: #{group.reference_name}"
        subscriptions = group.subscriptions
        subscriptions.each do |sub|
          UI.message "  - #{sub.product_id}: #{sub.state}"
        end
      end
    rescue => e
      UI.error "Could not fetch subscriptions: #{e.message}"
    end
    
  else
    UI.error "App not found!"
  end
end
lane :rejection_details do
  api_key = app_store_connect_api_key(
    key_id: "T9L7G79827",
    issuer_id: "e5761715-cdcf-42cb-b50e-09977a5c8279",
    key_filepath: "#{Dir.home}/private_keys/AuthKey_T9L7G79827.p8",
    duration: 1200
  )
  
  app = Spaceship::ConnectAPI::App.find("com.elev8tion.everydaychristian")
  
  UI.header "ðŸ“± Everyday Christian - Rejection Report"
  UI.message "Bundle ID: #{app.bundle_id}"
  UI.message ""
  
  # Get all versions
  edit_version = app.get_edit_app_store_version
  
  if edit_version
    UI.important "Version: #{edit_version.version_string}"
    UI.important "Status: #{edit_version.app_store_state}"
    UI.important "Created: #{edit_version.created_date}" if edit_version.created_date
    UI.message ""
    
    # Get subscription groups and products
    UI.header "ðŸ’° Subscription Configuration"
    begin
      groups = app.get_subscription_groups
      if groups.any?
        groups.each do |group|
          UI.message "Group: #{group.reference_name}"
          subs = group.subscriptions
          subs.each do |sub|
            UI.message "  â””â”€ Product ID: #{sub.product_id}"
            UI.message "     State: #{sub.state}"
            UI.message "     Name: #{sub.name}" if sub.name
          end
        end
      else
        UI.error "âŒ No subscription groups found!"
      end
    rescue => e
      UI.error "Error fetching subscriptions: #{e.message}"
    end
    
    UI.message ""
    UI.message "â”" * 60
    UI.important "To see detailed rejection reasons:"
    UI.important "1. Visit App Store Connect Resolution Center"
    UI.important "2. Or check your email for rejection notice from Apple"
    UI.message "â”" * 60
  else
    UI.error "No edit version found"
  end
end
#!/usr/bin/env ruby
# Query current subscription configuration via API

lane :query_subscriptions do
  api_key = app_store_connect_api_key(
    key_id: "T9L7G79827",
    issuer_id: "e5761715-cdcf-42cb-b50e-09977a5c8279",
    key_filepath: "#{Dir.home}/private_keys/AuthKey_T9L7G79827.p8",
    duration: 1200
  )
  
  UI.header "Querying Subscription Products"
  
  app = Spaceship::ConnectAPI::App.find("com.elev8tion.everydaychristian")
  
  # Get in-app purchases
  iaps = Spaceship::ConnectAPI.get_in_app_purchases(
    filter: { app: app.id },
    includes: "appStoreReviewScreenshot,iapPriceSchedule,inAppPurchaseLocalizations"
  )
  
  if iaps && iaps.count > 0
    UI.success "Found #{iaps.count} In-App Purchases/Subscriptions"
    UI.message ""
    
    iaps.each do |iap|
      UI.important "Product: #{iap.product_id}"
      UI.message "  Type: #{iap.in_app_purchase_type}"
      UI.message "  Reference Name: #{iap.reference_name}"
      UI.message "  State: #{iap.state}"
      UI.message ""
      
      # Get localizations
      if iap.in_app_purchase_localizations
        UI.header "Localizations:"
        iap.in_app_purchase_localizations.each do |loc|
          UI.message "  Language: #{loc.locale}"
          UI.message "  Name: #{loc.name}"
          UI.message "  Description: #{loc.description}"
          UI.message ""
        end
      end
    end
  else
    UI.error "No subscriptions found!"
  end
end
